<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | WhatsApp API</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #161623;
            overflow: hidden;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(#f00, #f0f);
            clip-path: circle(30% at right 70%);
        }

        body::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(#2196f3, #e91e63);
            clip-path: circle(20% at 10% 10%);
        }

        .container {
            position: relative;
            width: 350px;
            min-height: 400px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 25px 45px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 10;
        }

        .form {
            position: relative;
            width: 100%;
            height: 100%;
            padding: 40px;
        }

        .form h2 {
            position: relative;
            color: #fff;
            font-size: 24px;
            font-weight: 600;
            letter-spacing: 1px;
            margin-bottom: 40px;
            text-align: center;
        }

        .form h2::before {
            content: '';
            position: absolute;
            left: 50%;
            bottom: -10px;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background: #fff;
            border-radius: 2px;
        }

        .inputBox {
            width: 100%;
            margin-top: 20px;
        }

        .inputBox input {
            width: 100%;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            outline: none;
            padding: 10px 20px;
            border-radius: 35px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 16px;
            letter-spacing: 1px;
            color: #fff;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .inputBox input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .inputBox input[type="submit"] {
            background: #fff;
            color: #666;
            max-width: 100px;
            cursor: pointer;
            margin-bottom: 20px;
            font-weight: 600;
            transition: 0.3s;
        }
        
        .btn-submit {
            width: 100%;
            background: linear-gradient(45deg, #ff357a, #fff172);
            border: none;
            outline: none;
            padding: 10px 20px;
            border-radius: 35px;
            font-size: 16px;
            letter-spacing: 1px;
            color: #fff;
            cursor: pointer;
            margin-top: 20px;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: 0.3s;
        }

        .btn-submit:hover {
            transform: scale(1.05);
        }

        .forget {
            margin-top: 10px;
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .forget label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .forget label input {
            margin-right: 5px;
        }

        .forget a {
            color: #fff;
            font-weight: 600;
            text-decoration: none;
        }

        .forget a:hover {
            text-decoration: underline;
        }
        
        .status-msg {
            text-align: center;
            margin-top: 15px;
            color: #fff;
            font-size: 14px;
            min-height: 20px;
        }
        
        .user-icon {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .user-icon i {
            font-size: 80px;
            color: rgba(255,255,255,0.5);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="form">
            <div class="user-icon">
                <i class="fas fa-user-circle"></i>
            </div>
            <h2>Login</h2>
            <form id="loginForm">
                <div class="inputBox" id="nameBox" style="display:none;">
                    <input type="text" id="name" placeholder="Tu Nombre">
                </div>
                <div class="inputBox">
                    <input type="text" id="identifier" placeholder="Email o Teléfono" required>
                </div>
                <div class="inputBox">
                    <input type="password" id="password" placeholder="Contraseña" required>
                </div>
                <div class="forget">
                    <label>
                        <input type="checkbox" id="rememberMe"> Recordarme
                    </label>
                    <a href="#" id="forgotBtn">¿Olvidaste tu contraseña?</a>
                </div>
                <button type="submit" class="btn-submit" id="submitBtn">INGRESAR</button>
                
                <div class="register-link">
                    <p>¿No tienes una cuenta? <a href="#" id="toggleRegister">Regístrate</a></p>
                </div>

                <div class="status-msg" id="msg"></div>
            </form>
        </div>
    </div>

    <script>
        const loginForm = document.getElementById('loginForm');
        const msgDiv = document.getElementById('msg');
        const forgotBtn = document.getElementById('forgotBtn');
        const toggleBtn = document.getElementById('toggleRegister');
        const nameBox = document.getElementById('nameBox');
        const title = document.querySelector('.form h2');
        const submitBtn = document.getElementById('submitBtn');
        const rememberDiv = document.querySelector('.forget label');
        const forgotLink = document.getElementById('forgotBtn');

        let isRegisterMode = false;

        toggleBtn.addEventListener('click', (e) => {
            e.preventDefault();
            isRegisterMode = !isRegisterMode;
            
            if (isRegisterMode) {
                // Modo Registro
                title.textContent = 'Registro';
                nameBox.style.display = 'block';
                document.getElementById('name').setAttribute('required', 'true');
                submitBtn.textContent = 'REGISTRARSE';
                toggleBtn.textContent = 'Ingresa aquí';
                toggleBtn.parentElement.innerHTML = '¿Ya tienes una cuenta? <a href="#" id="toggleRegister">Ingresa aquí</a>';
                // Re-bind event since we replaced innerHTML
                document.getElementById('toggleRegister').addEventListener('click', toggleClickHandler);
                
                rememberDiv.style.visibility = 'hidden';
                forgotLink.style.visibility = 'hidden';
            } else {
                // Modo Login
                title.textContent = 'Login';
                nameBox.style.display = 'none';
                document.getElementById('name').removeAttribute('required');
                submitBtn.textContent = 'INGRESAR';
                toggleBtn.textContent = 'Regístrate';
                toggleBtn.parentElement.innerHTML = '¿No tienes una cuenta? <a href="#" id="toggleRegister">Regístrate</a>';
                // Re-bind event
                document.getElementById('toggleRegister').addEventListener('click', toggleClickHandler);
                
                rememberDiv.style.visibility = 'visible';
                forgotLink.style.visibility = 'visible';
            }
            msgDiv.textContent = '';
        });

        function toggleClickHandler(e) {
            e.preventDefault();
            toggleBtn.click(); // Reuse existing logic by triggering click on the original (conceptually)
            // Actually, better to just extract the logic or simpler: reload page? No.
            // Let's just create a function for the toggle logic.
        }

        // To avoid complexity with re-binding, let's use a static listener on parent or cleaner separate function
        // Re-writing toggle logic to be cleaner:
        
        const registerContainer = document.querySelector('.register-link p');
        
        function updateToggleLink() {
            const text = isRegisterMode 
                ? '¿Ya tienes una cuenta? <a href="#" id="toggleRegister">Ingresa aquí</a>'
                : '¿No tienes una cuenta? <a href="#" id="toggleRegister">Regístrate</a>';
            registerContainer.innerHTML = text;
            document.getElementById('toggleRegister').addEventListener('click', (e) => {
                e.preventDefault();
                isRegisterMode = !isRegisterMode;
                updateUI();
            });
        }

        function updateUI() {
            if (isRegisterMode) {
                title.textContent = 'Registro';
                nameBox.style.display = 'block';
                document.getElementById('name').setAttribute('required', 'true');
                submitBtn.textContent = 'REGISTRARSE';
                rememberDiv.style.visibility = 'hidden';
                forgotLink.style.visibility = 'hidden';
            } else {
                title.textContent = 'Login';
                nameBox.style.display = 'none';
                document.getElementById('name').removeAttribute('required');
                submitBtn.textContent = 'INGRESAR';
                rememberDiv.style.visibility = 'visible';
                forgotLink.style.visibility = 'visible';
            }
            updateToggleLink();
            msgDiv.textContent = '';
        }

        // Initial bind (overwrite the previous simple one)
        updateToggleLink();


        // ... (Keep existing Forgot Password and Window Load logic) ...
        // Forgot Password
        forgotBtn.addEventListener('click', async (e) => {
             // ... existing code ...
             e.preventDefault();
            const email = document.getElementById('identifier').value;
            if (!email || !email.includes('@')) {
                showMessage('Por favor ingresa tu email para recuperar la contraseña', 'orange');
                return;
            }
            showMessage('Enviando instrucciones...', 'white');
            try {
                const res = await fetch('/api/forgot-password', { 
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email })
                });
                showMessage('Si el correo es válido, recibirás instrucciones de recuperación.', 'lightgreen');
            } catch (error) {
                showMessage('Error al procesar solicitud', 'red');
            }
        });

        window.addEventListener('load', () => {
            const remembered = localStorage.getItem('wa_remembered_user');
            if (remembered) {
                document.getElementById('identifier').value = remembered;
                document.getElementById('rememberMe').checked = true;
            }
        });

        function showMessage(text, color) {
            msgDiv.style.color = color;
            msgDiv.textContent = text;
        }

        loginForm.onsubmit = async function(e) {
            e.preventDefault();
            const identifier = document.getElementById('identifier').value;
            const password = document.getElementById('password').value;
            const name = document.getElementById('name').value;
            const rememberMe = document.getElementById('rememberMe').checked;

            showMessage('Procesando...', 'white');

            const isEmail = identifier.includes('@');
            const payload = { password, name };
            if (isEmail) payload.email = identifier;
            else payload.numero = identifier;

            const endpoint = isRegisterMode ? '/api/registro' : '/api/login';

            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (res.ok && data.token) {
                    // Success
                    localStorage.setItem('wa_session', JSON.stringify({ 
                        token: data.token,
                        identifier: identifier 
                    }));
                    
                    if (rememberMe && !isRegisterMode) {
                        localStorage.setItem('wa_remembered_user', identifier);
                    } else if (!rememberMe) {
                        localStorage.removeItem('wa_remembered_user');
                    }

                    showMessage(`¡${isRegisterMode ? 'Registro exitoso' : 'Bienvenido'}!`, 'lightgreen');
                    setTimeout(() => {
                        window.location.href = '/dashboard.html';
                    }, 1000);
                } else {
                    showMessage(data.error || 'Error en la operación', 'red');
                }
            } catch (err) {
                console.error(err);
                showMessage('Error de conexión con el servidor', 'red');
            }
        };
    </script>
</body>
</html>